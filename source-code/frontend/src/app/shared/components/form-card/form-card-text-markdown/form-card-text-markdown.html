<div class="mb-3">

  <!-- Input label -->
  <label [for]="id" class="form-label fw-semibold">{{ label }}</label>

  <div class="input-group align-items-start">

    <div class="d-flex flex-column align-items-end gap-1">

      <!-- Input field icon -->
      @if (icon) {
        <span class="input-group-text text-muted pt-2">
          <fa-icon [icon]="icon!"></fa-icon>
        </span>
      }

      <!-- Toggle button: switches between edit and markdown preview mode -->
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary"
        style="--bs-btn-padding-y: .30rem; --bs-btn-padding-x: .40rem;"
        [disabled]="!control.value && !isPreview"
        [title]="isPreview ? 'Back to edit' : 'Preview markdown'"
        (click)="togglePreview()">
        <fa-icon [icon]="isPreview ? icons.edit : icons.preview"></fa-icon>
      </button>

      <!-- Full-screen button: opens the ng-bootstrap modal, only visible in preview mode -->
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary"
        style="--bs-btn-padding-y: .30rem; --bs-btn-padding-x: .40rem;"
        [disabled]="!isPreview"
        title="Full screen preview"
        (click)="openFullPreview(previewModal)">
        <fa-icon [icon]="icons.fullscreen"></fa-icon>
      </button>

    </div>

    <!-- Edit mode: normal textarea -->
    @if (!isPreview) {
      <textarea
        [id]="id"
        [formControl]="control"
        [placeholder]="placeholder"
        class="form-control"
        [class.is-invalid]="control.invalid && control.touched"
        [class.is-valid]="control.valid && control.touched"
        [style.height]="currentTextareaHeight"
        rows="5"
        (mouseup)="onTextareaMouseUp($event)">
      </textarea>
    }

    <!-- Preview mode: rendered and sanitized markdown output -->
    @if (isPreview) {
      <div
        class="form-control markdown-preview"
        markdown
        [style.min-height]="currentTextareaHeight"
        [data]="control.value ?? '*Nothing to preview.*'">
      </div>
    }

  </div>

  <!-- Error message (shown only in edit mode) -->
  @if (!isPreview && control.invalid && control.touched) {
    @for (error of errors | keyvalue; track error.key) {
      @if (control.hasError(error.key)) {
        <div class="invalid-feedback d-block">
          {{ error.value }}
        </div>
      }
    }
  }

</div>

<!-- ng-bootstrap modal template for full-screen markdown preview -->
<ng-template #previewModal let-modal>

  <div class="modal-header">
    <h5 class="modal-title fw-semibold">{{ label }} - Markdown Preview</h5>
    <button
      type="button"
      class="btn-close"
      (click)="modal.dismiss()"
      aria-label="Close">
    </button>
  </div>

  <!-- Rendered markdown -->
  <div
    class="modal-body markdown-modal-body"
    markdown
    [data]="control.value ?? '*Nothing to preview.*'">
  </div>

</ng-template>